{
    "file_name": "nanhaishu_whitepaper",
    "tactic_label": true,
    "rewrite": {
        "Initial Access": "The threat actor behind NanHaiShu malware used spearphishing email messages as the infection vector to deliver the malware to targeted entities, including the Department of Justice of the Philippines, the organizers of the Asia-Pacific Economic Cooperation (APEC) Summit, and a major international law firm. The emails contained industry-specific terms and were crafted to appear legitimate to the recipients. The attached files, usually XLS or DOC, contained a VBA macro that executed an embedded JScript file. The attack relied on the targets having modified the default security setting in Microsoft Office to allow macro execution.",
        "Execution": "Upon enabling the malicious macro, NanHaiShu's VBA macro decodes and runs, writing JScript data to '%appdata%\\Microsoft\\Network\\network.js' and executing it. The macro also decodes a decoy XLS file, saves it using the same filename as the malicious XLS, and loads the decoy. A VBScript file is created to delete the original file. The network.js file modifies the '%regrun%' registry to point to itself as its autostart mechanism.",
        "Persistence": "NanHaiShu establishes persistence by modifying the '%regrun%' registry entry to point to the network.js file, ensuring it starts automatically.",
        "Defense Evasion": "The malware uses base64 encoding to embed the decoy XLS and JScript file. For the recent sample, the URL string used inside the JScript code was obfuscated in two layers; it had to be decoded using base64, then decrypted using a routine that extracts and converts a Unicode number to a character.",
        "Discovery": "NanHaiShu gathers system information from the infected machine, including Volume Serial Number, IP Address, Computer Name, User Name, Operating System, and Proxy Server, and uploads it to the C&C server.",
        "Command and Control": "NanHaiShu communicates with C&C servers using dynamic DNS providers. The malware uses HTTP POST to upload encoded system information and HTTP GET to download and execute JScript and VBScript code. The C&C servers initially resolved to IP addresses hosted in the United States but switched to a Chinese IP address on October 26th, 2015.",
        "Exfiltration": "The malware is capable of receiving and executing additional JScript and VBScript code, which can be used for exfiltration of data. The downloaded files or scripts may then be used to exfiltrate data that is likely to be highly sensitive, given the profile of its targets.",
        "Others": "The threat actor behind NanHaiShu is believed to be of Chinese origin, targeting entities involved in the South China Sea dispute. The malware's VBA base64 decoder function is associated with Chinese programmers, and the C&C servers pointed to a Chinese AS coinciding with news reports of US ship movements in the South China Sea. The malware is a Remote Access Trojan (RAT) capable of sending system information to a remote C&C server and executing additional code for potential data exfiltration."
    },
    "technique_label": true,
    "triplet_groups": {
        "Initial Access": {
            "T1566-Phishing": [
                {
                    "Subject": "threat actor behind NanHaiShu",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "spearphishing email messages",
                    "ObjectType": "Email Message",
                    "tactic": "Initial Access",
                    "technique": [
                        "T1566-Phishing"
                    ],
                    "id": 1
                },
                {
                    "Subject": "spearphishing email messages",
                    "SubjectType": "Email Message",
                    "Relation": "deliver",
                    "Object": "NanHaiShu",
                    "ObjectType": "Malware",
                    "tactic": "Initial Access",
                    "technique": [
                        "T1566-Phishing"
                    ],
                    "id": 2
                }
            ]
        },
        "Defense Evasion": {
            "T1027-Obfuscated Files or Information": [
                {
                    "Subject": "The malware",
                    "SubjectType": "Malware",
                    "Relation": "use",
                    "Object": "base64 encoding",
                    "ObjectType": "Technique",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1027-Obfuscated Files or Information",
                        "T1140-Deobfuscate/Decode Files or Information"
                    ],
                    "id": 5
                },
                {
                    "Subject": "URL string",
                    "SubjectType": "Artifact",
                    "Relation": "obfuscated in",
                    "Object": "two layers",
                    "ObjectType": "Technique",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1027-Obfuscated Files or Information",
                        "T1140-Deobfuscate/Decode Files or Information"
                    ],
                    "id": 6
                },
                {
                    "Subject": "URL string",
                    "SubjectType": "Artifact",
                    "Relation": "decoded using",
                    "Object": "base64",
                    "ObjectType": "Technique",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1027-Obfuscated Files or Information",
                        "T1140-Deobfuscate/Decode Files or Information"
                    ],
                    "id": 7
                },
                {
                    "Subject": "URL string",
                    "SubjectType": "Artifact",
                    "Relation": "decrypted using",
                    "Object": "routine",
                    "ObjectType": "Technique",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1027-Obfuscated Files or Information",
                        "T1140-Deobfuscate/Decode Files or Information"
                    ],
                    "id": 8
                }
            ],
            "T1140-Deobfuscate/Decode Files or Information": [
                {
                    "Subject": "The malware",
                    "SubjectType": "Malware",
                    "Relation": "use",
                    "Object": "base64 encoding",
                    "ObjectType": "Technique",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1027-Obfuscated Files or Information",
                        "T1140-Deobfuscate/Decode Files or Information"
                    ],
                    "id": 5
                },
                {
                    "Subject": "URL string",
                    "SubjectType": "Artifact",
                    "Relation": "obfuscated in",
                    "Object": "two layers",
                    "ObjectType": "Technique",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1027-Obfuscated Files or Information",
                        "T1140-Deobfuscate/Decode Files or Information"
                    ],
                    "id": 6
                },
                {
                    "Subject": "URL string",
                    "SubjectType": "Artifact",
                    "Relation": "decoded using",
                    "Object": "base64",
                    "ObjectType": "Technique",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1027-Obfuscated Files or Information",
                        "T1140-Deobfuscate/Decode Files or Information"
                    ],
                    "id": 7
                },
                {
                    "Subject": "URL string",
                    "SubjectType": "Artifact",
                    "Relation": "decrypted using",
                    "Object": "routine",
                    "ObjectType": "Technique",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1027-Obfuscated Files or Information",
                        "T1140-Deobfuscate/Decode Files or Information"
                    ],
                    "id": 8
                }
            ]
        },
        "Command and Control": {
            "T1071-Application Layer Protocol": [
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "communicates with",
                    "Object": "C&C servers",
                    "ObjectType": "infrastructure",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1568-Dynamic Resolution",
                        "T1132-Data Encoding"
                    ],
                    "id": 9
                },
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "uses",
                    "Object": "HTTP POST",
                    "ObjectType": "network traffic",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1132-Data Encoding"
                    ],
                    "id": 10
                },
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "uses",
                    "Object": "HTTP GET",
                    "ObjectType": "network traffic",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1132-Data Encoding"
                    ],
                    "id": 11
                },
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "download and execute",
                    "Object": "JScript and VBScript code",
                    "ObjectType": "file",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1132-Data Encoding"
                    ],
                    "id": 12
                },
                {
                    "Subject": "The C&C servers",
                    "SubjectType": "infrastructure",
                    "Relation": "initially resolved to",
                    "Object": "IP addresses hosted in the United States",
                    "ObjectType": "Location",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1568-Dynamic Resolution"
                    ],
                    "id": 13
                },
                {
                    "Subject": "The C&C servers",
                    "SubjectType": "infrastructure",
                    "Relation": "switched to",
                    "Object": "a Chinese IP address",
                    "ObjectType": "ipv4-addr",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1568-Dynamic Resolution"
                    ],
                    "id": 14
                }
            ],
            "T1568-Dynamic Resolution": [
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "communicates with",
                    "Object": "C&C servers",
                    "ObjectType": "infrastructure",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1568-Dynamic Resolution",
                        "T1132-Data Encoding"
                    ],
                    "id": 9
                },
                {
                    "Subject": "The C&C servers",
                    "SubjectType": "infrastructure",
                    "Relation": "initially resolved to",
                    "Object": "IP addresses hosted in the United States",
                    "ObjectType": "Location",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1568-Dynamic Resolution"
                    ],
                    "id": 13
                },
                {
                    "Subject": "The C&C servers",
                    "SubjectType": "infrastructure",
                    "Relation": "switched to",
                    "Object": "a Chinese IP address",
                    "ObjectType": "ipv4-addr",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1568-Dynamic Resolution"
                    ],
                    "id": 14
                }
            ],
            "T1132-Data Encoding": [
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "communicates with",
                    "Object": "C&C servers",
                    "ObjectType": "infrastructure",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1568-Dynamic Resolution",
                        "T1132-Data Encoding"
                    ],
                    "id": 9
                },
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "uses",
                    "Object": "HTTP POST",
                    "ObjectType": "network traffic",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1132-Data Encoding"
                    ],
                    "id": 10
                },
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "uses",
                    "Object": "HTTP GET",
                    "ObjectType": "network traffic",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1132-Data Encoding"
                    ],
                    "id": 11
                },
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "download and execute",
                    "Object": "JScript and VBScript code",
                    "ObjectType": "file",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1071-Application Layer Protocol",
                        "T1132-Data Encoding"
                    ],
                    "id": 12
                }
            ]
        },
        "Execution": {
            "T1059-Command and Scripting Interpreter": [
                {
                    "Subject": "NanHaiShu's VBA macro",
                    "SubjectType": "Malware",
                    "Relation": "decode and run",
                    "Object": "JScript data",
                    "ObjectType": "artifacts",
                    "tactic": "Execution",
                    "technique": [
                        "T1059-Command and Scripting Interpreter"
                    ],
                    "id": 15
                },
                {
                    "Subject": "NanHaiShu's VBA macro",
                    "SubjectType": "Malware",
                    "Relation": "write and execute",
                    "Object": "network.js",
                    "ObjectType": "file",
                    "tactic": "Execution",
                    "technique": [
                        "T1059-Command and Scripting Interpreter"
                    ],
                    "id": 16
                },
                {
                    "Subject": "NanHaiShu's VBA macro",
                    "SubjectType": "Malware",
                    "Relation": "decode",
                    "Object": "decoy XLS file",
                    "ObjectType": "file",
                    "tactic": "Execution",
                    "technique": [
                        "T1059-Command and Scripting Interpreter"
                    ],
                    "id": 17
                },
                {
                    "Subject": "NanHaiShu's VBA macro",
                    "SubjectType": "Malware",
                    "Relation": "save and load",
                    "Object": "decoy XLS file",
                    "ObjectType": "file",
                    "tactic": "Execution",
                    "technique": [
                        "T1059-Command and Scripting Interpreter"
                    ],
                    "id": 18
                },
                {
                    "Subject": "VBScript file",
                    "SubjectType": "file",
                    "Relation": "create",
                    "Object": "deletion of the original file",
                    "ObjectType": "course-of-action",
                    "tactic": "Execution",
                    "technique": [
                        "T1059-Command and Scripting Interpreter"
                    ],
                    "id": 19
                },
                {
                    "Subject": "network.js file",
                    "SubjectType": "file",
                    "Relation": "modify",
                    "Object": "'%regrun%' registry",
                    "ObjectType": "registry",
                    "tactic": "Execution",
                    "technique": [
                        "T1059-Command and Scripting Interpreter"
                    ],
                    "id": 20
                }
            ]
        },
        "Persistence": {
            "T1547-Boot or Logon Autostart Execution": [
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "modify",
                    "Object": "'%regrun%' registry entry",
                    "ObjectType": "registry",
                    "tactic": "Persistence",
                    "technique": [
                        "T1547-Boot or Logon Autostart Execution"
                    ],
                    "id": 21
                },
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "ensure",
                    "Object": "network.js file",
                    "ObjectType": "file",
                    "tactic": "Persistence",
                    "technique": [
                        "T1547-Boot or Logon Autostart Execution"
                    ],
                    "id": 22
                }
            ]
        },
        "Discovery": {
            "T1082-System Information Discovery": [
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "gather",
                    "Object": "system information",
                    "ObjectType": "artifacts",
                    "tactic": "Discovery",
                    "technique": [
                        "T1082-System Information Discovery"
                    ],
                    "id": 23
                },
                {
                    "Subject": "NanHaiShu",
                    "SubjectType": "Malware",
                    "Relation": "upload",
                    "Object": "system information",
                    "ObjectType": "artifacts",
                    "tactic": "Discovery",
                    "technique": [
                        "T1082-System Information Discovery"
                    ],
                    "id": 24
                }
            ]
        },
        "Exfiltration": {
            "T1041-Exfiltration Over C2 Channel": [
                {
                    "Subject": "The malware",
                    "SubjectType": "Malware",
                    "Relation": "capable-of",
                    "Object": "receiving and executing additional JScript and VBScript code",
                    "ObjectType": "artifact",
                    "tactic": "Exfiltration",
                    "technique": [
                        "T1041-Exfiltration Over C2 Channel"
                    ],
                    "id": 25
                },
                {
                    "Subject": "The malware",
                    "SubjectType": "Malware",
                    "Relation": "use",
                    "Object": "downloaded files or scripts",
                    "ObjectType": "artifact",
                    "tactic": "Exfiltration",
                    "technique": [
                        "T1041-Exfiltration Over C2 Channel"
                    ],
                    "id": 26
                },
                {
                    "Subject": "downloaded files or scripts",
                    "SubjectType": "artifact",
                    "Relation": "exfiltrate-to",
                    "Object": "data",
                    "ObjectType": "artifact",
                    "tactic": "Exfiltration",
                    "technique": [
                        "T1041-Exfiltration Over C2 Channel"
                    ],
                    "id": 27
                },
                {
                    "Subject": "data",
                    "SubjectType": "artifact",
                    "Relation": "likely-to-be",
                    "Object": "highly sensitive",
                    "ObjectType": "artifact",
                    "tactic": "Exfiltration",
                    "technique": [
                        "T1041-Exfiltration Over C2 Channel"
                    ],
                    "id": 28
                }
            ]
        }
    }
}