{
    "file_name": "research.nccgroup.com-Abusing cloud services to fly under the radar",
    "tactic_label": true,
    "rewrite": {
        "Initial Access": "This adversary starts with obtaining usernames and passwords of their victim from previous breaches. These credentials are used in a credential stuffing or password spraying attack against the victim's remote services, such as webmail or other internet reachable mail services. After obtaining a valid account, they use this account to access the victim's VPN, Citrix or another remote service that allows access to the network of the victim. Information regarding these remotes services is taken from the mailbox, cloud drive, or other cloud resources accessible by the compromised account.",
        "Execution": "The adversary installs Cobalt Strike, a framework designed for adversary simulation intended for penetration testers and red teams, which has been widely adopted by malicious threats. The Cobalt Strike beacon is installed in memory by using a PowerShell one-liner. At least three versions of Cobalt Strike have been in use by the adversary: v3.8, v3.12, and v3.14. The adversary heavily relies on scheduled tasks for executing a batch-file (.bat) to perform their tasks.",
        "Persistence": "The adversary loads the Cobalt Strike beacon in memory, without any persistence mechanisms on the compromised system. Once the system is rebooted, the beacon is gone. The adversary is still able to have persistent access by installing the beacon on systems with high uptimes, such as servers. Besides using the Cobalt Strike beacon, the adversary also searches for VPN and firewall configs, possibly to function as a backup access into the network.",
        "Privilege Escalation": "The adversary started a password spraying attack against domain admin accounts, and successfully got a valid domain admin account this way. In other cases, the adversary moved laterally to another system with a domain admin logged in. They used a tool called NtdsAudit to dump the password hashes of domain users as well as observed the following command: msadcs.exe \"NTDS.dit\" -s \"SYSTEM\" -p RecordedTV_pdmp.txt --users-csv RecordedTV_users.csv. Both ntdsutil and esentutl are by default installed on a domain controller.",
        "Defense Evasion": "The adversary attempts to clean-up some of the traces from their intrusions. While we don't know what was deleted and we were unable to recover, we did see some of their anti-forensics activity: Windows event logs clearing, File deletion, Timestomping. For indicator removal on host: Timestomp the adversary uses a Windows version of the Linux touch command. This tool is included in the UnxUtils repository. This makes sure the used tools by the adversary blend in with the other files in the directory when shown in a timeline.",
        "Credential Access": "The adversary achieves credentials access by brute force, and more specifically by credential stuffing or password spraying. The traces in log files showed more than usual login attempts with a username formatted as email address, e.g.<username>@<email domain>. While usernames for legitimate logins at the victim's network were generally formatted like <domain>\\<username>. And attempted logins came from a relative small set of IP-addresses.",
        "Discovery": "The adversary applied a wide range of discovery tactics. In the list below we have highlighted a few specific tools the adversary used for discovery purposes. You can find a summary of most of the commands used by the adversary to perform discovery at the end of this article. Account discovery tool: PsLogList Command used: psloglist.exe -accepteula -x security -s -a <date> This command exports a text file with comma separated fields. The text files contain the contents of the Security Event log after the specified date. Psloglist is part of the Sysinternals toolkit from Mark Russinovich (Microsoft). The tool was used by the adversary on various systems to write events from the Windows Security Event Log to a text file. A possible intent of the adversary could be to identify if privileged users are active on the systems. If such a privileged user was recently active on a server the actor executes Cobalt Strike's built-in Mimikatz to dump its credentials or password hash.",
        "Lateral Movement": "The adversary used the built-in lateral movement possibilities in Cobalt Strike. Cobalt Strike has various methods for deploying its beacons at newly compromised systems. We have seen the adversary using SMB, named pipes, PsExec, and WinRM. The adversary attempts to move to a domain controller as soon as possible after getting foothold into the victim's network. They continue lateral movement and discovery in an attempt to identify the data of interest. This could be a webserver to carve PII from memory, or a fileserver to copy IP, as we have both observed.",
        "Collection": "In preparation of exfiltration of the data needed for their objective, the adversary collected the data from various sources within the victim's network. As described before, the adversary collected data from an information repository, Microsoft SharePoint Online in this case. This document was exfiltrated and used to continue the intrusion via a company portal and VPN. In all cases we've seen the adversary copying results of the discovery phase, like file- and directory lists from local systems, network shared drives, and file shares on remote systems. But email collection is also important for this adversary: with every intrusion we saw the mailbox of some users being copied, from both local and remote systems.",
        "Command and Control": "The adversary uses Cobalt Strike as framework to manage their compromised systems. We observed the use of Cobalt Strike's C2 protocol encapsulated in DNS by the adversary in 2017 and 2018. They switched to C2 encapsulated in HTTPS in Q3 2019. An interesting observation is they made use of a cracked/patched trial version of Cobalt Strike. This is important to note because the functionalities of Cobalt Strike's trial version are limited. More importantly: the trial version doesn't support encryption of command and control traffic in cases where the protocol itself isn't encrypted, such as DNS.",
        "Exfiltration": "The adversary uses the command and control channel to exfiltrate small amounts of data. This is usually information containing account details. For large amounts of data, such as the mailboxes and network shares with intellectual property, they use something else. Once the larger chunks of data are compressed, encrypted, and staged, the data is exfiltrated using a custom built tool. This tool exfiltrates specified files to cloud storage web services. The following cloud storage web services are supported by the malware: Dropbox, Google Drive, OneDrive."
    },
    "technique_label": true,
    "triplet_groups": {
        "Initial Access": {
            "T1078-Valid Accounts": [
                {
                    "Subject": "adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "obtain",
                    "Object": "usernames and passwords",
                    "ObjectType": "artifacts",
                    "tactic": "Initial Access",
                    "technique": [
                        "T1078-Valid Accounts"
                    ],
                    "id": 1
                },
                {
                    "Subject": "credentials",
                    "SubjectType": "artifacts",
                    "Relation": "use",
                    "Object": "credential stuffing or password spraying attack",
                    "ObjectType": "attack-pattern",
                    "tactic": "Initial Access",
                    "technique": [
                        "T1078-Valid Accounts"
                    ],
                    "id": 2
                },
                {
                    "Subject": "threat-actor",
                    "SubjectType": "threat-actor",
                    "Relation": "access",
                    "Object": "victim's VPN, Citrix or another remote service",
                    "ObjectType": "infrastrcucture",
                    "tactic": "Initial Access",
                    "technique": [
                        "T1078-Valid Accounts"
                    ],
                    "id": 3
                },
                {
                    "Subject": "compromised account",
                    "SubjectType": "user-account",
                    "Relation": "access",
                    "Object": "mailbox, cloud drive, or other cloud resources",
                    "ObjectType": "infrastrcucture",
                    "tactic": "Initial Access",
                    "technique": [
                        "T1078-Valid Accounts"
                    ],
                    "id": 4
                }
            ]
        },
        "Execution": {
            "T1059-Command and Scripting Interpreter": [
                {
                    "Subject": "adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "install",
                    "Object": "Cobalt Strike beacon",
                    "ObjectType": "tool",
                    "tactic": "Execution",
                    "technique": [
                        "T1059-Command and Scripting Interpreter"
                    ],
                    "id": 5
                }
            ],
            "T1053-Scheduled Task/Job": [
                {
                    "Subject": "adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "rely on",
                    "Object": "scheduled tasks",
                    "ObjectType": "technique",
                    "tactic": "Execution",
                    "technique": [
                        "T1053-Scheduled Task/Job"
                    ],
                    "id": 6
                }
            ]
        },
        "Defense Evasion": {
            "T1070-Indicator Removal": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "attempt",
                    "Object": "clean-up traces from their intrusions",
                    "ObjectType": "technique",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1070-Indicator Removal"
                    ],
                    "id": 10
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "clear",
                    "Object": "Windows event logs",
                    "ObjectType": "artifacts",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1070-Indicator Removal"
                    ],
                    "id": 11
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "delete",
                    "Object": "File",
                    "ObjectType": "artifacts",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1070-Indicator Removal"
                    ],
                    "id": 12
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "Timestomping",
                    "ObjectType": "technique",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1070-Indicator Removal"
                    ],
                    "id": 13
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "Windows version of the Linux touch command",
                    "ObjectType": "tool",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1070-Indicator Removal"
                    ],
                    "id": 14
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "include",
                    "Object": "tool",
                    "ObjectType": "tool",
                    "tactic": "Defense Evasion",
                    "technique": [
                        "T1070-Indicator Removal"
                    ],
                    "id": 15
                }
            ]
        },
        "Discovery": {
            "T1654-Log Enumeration": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "PsLogList",
                    "ObjectType": "tool",
                    "tactic": "Discovery",
                    "technique": [
                        "T1654-Log Enumeration"
                    ],
                    "id": 16
                }
            ],
            "T1082-System Information Discovery": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "execute",
                    "Object": "Cobalt Strike's built-in Mimikatz",
                    "ObjectType": "tool",
                    "tactic": "Discovery",
                    "technique": [
                        "T1082-System Information Discovery"
                    ],
                    "id": 17
                }
            ]
        },
        "Collection": {
            "T1213-Data from Information Repositories": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "collect",
                    "Object": "data",
                    "ObjectType": "artifacts",
                    "tactic": "Collection",
                    "technique": [
                        "T1213-Data from Information Repositories"
                    ],
                    "id": 19
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "Microsoft SharePoint Online",
                    "ObjectType": "software",
                    "tactic": "Collection",
                    "technique": [
                        "T1213-Data from Information Repositories"
                    ],
                    "id": 20
                }
            ],
            "T1005-Data from Local System": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "copy",
                    "Object": "results of the discovery phase",
                    "ObjectType": "artifacts",
                    "tactic": "Collection",
                    "technique": [
                        "T1005-Data from Local System",
                        "T1039-Data from Network Shared Drive"
                    ],
                    "id": 22
                }
            ],
            "T1039-Data from Network Shared Drive": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "copy",
                    "Object": "results of the discovery phase",
                    "ObjectType": "artifacts",
                    "tactic": "Collection",
                    "technique": [
                        "T1005-Data from Local System",
                        "T1039-Data from Network Shared Drive"
                    ],
                    "id": 22
                }
            ],
            "T1114-Email Collection": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "collect",
                    "Object": "email",
                    "ObjectType": "Email Message",
                    "tactic": "Collection",
                    "technique": [
                        "T1114-Email Collection"
                    ],
                    "id": 23
                }
            ]
        },
        "Command and Control": {
            "T1573-Encrypted Channel": [
                {
                    "Subject": "adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "Cobalt Strike",
                    "ObjectType": "tool",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1573-Encrypted Channel"
                    ],
                    "id": 24
                },
                {
                    "Subject": "adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "cracked/patched trial version of Cobalt Strike",
                    "ObjectType": "tool",
                    "tactic": "Command and Control",
                    "technique": [
                        "T1573-Encrypted Channel"
                    ],
                    "id": 25
                }
            ]
        },
        "Exfiltration": {
            "T1041-Exfiltration Over C2 Channel": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "command and control channel",
                    "ObjectType": "network traffic",
                    "tactic": "Exfiltration",
                    "technique": [
                        "T1041-Exfiltration Over C2 Channel",
                        "T1537-Transfer Data to Cloud Account"
                    ],
                    "id": 26
                }
            ],
            "T1537-Transfer Data to Cloud Account": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "command and control channel",
                    "ObjectType": "network traffic",
                    "tactic": "Exfiltration",
                    "technique": [
                        "T1041-Exfiltration Over C2 Channel",
                        "T1537-Transfer Data to Cloud Account"
                    ],
                    "id": 26
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "exfiltrate-to",
                    "Object": "cloud storage web services",
                    "ObjectType": "network traffic",
                    "tactic": "Exfiltration",
                    "technique": [
                        "T1567-Exfiltration Over Web Service",
                        "T1537-Transfer Data to Cloud Account"
                    ],
                    "id": 27
                },
                {
                    "Subject": "The malware",
                    "SubjectType": "Malware",
                    "Relation": "support",
                    "Object": "Dropbox, Google Drive, OneDrive",
                    "ObjectType": "software",
                    "tactic": "Exfiltration",
                    "technique": [
                        "T1567-Exfiltration Over Web Service",
                        "T1537-Transfer Data to Cloud Account"
                    ],
                    "id": 28
                }
            ],
            "T1567-Exfiltration Over Web Service": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "exfiltrate-to",
                    "Object": "cloud storage web services",
                    "ObjectType": "network traffic",
                    "tactic": "Exfiltration",
                    "technique": [
                        "T1567-Exfiltration Over Web Service",
                        "T1537-Transfer Data to Cloud Account"
                    ],
                    "id": 27
                },
                {
                    "Subject": "The malware",
                    "SubjectType": "Malware",
                    "Relation": "support",
                    "Object": "Dropbox, Google Drive, OneDrive",
                    "ObjectType": "software",
                    "tactic": "Exfiltration",
                    "technique": [
                        "T1567-Exfiltration Over Web Service",
                        "T1537-Transfer Data to Cloud Account"
                    ],
                    "id": 28
                }
            ]
        },
        "Privilege Escalation": {
            "T1078-Valid Accounts": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "start",
                    "Object": "password spraying attack",
                    "ObjectType": "attack-pattern",
                    "tactic": "Privilege Escalation",
                    "technique": [
                        "T1078-Valid Accounts"
                    ],
                    "id": 29
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "get",
                    "Object": "valid domain admin account",
                    "ObjectType": "user-account",
                    "tactic": "Privilege Escalation",
                    "technique": [
                        "T1078-Valid Accounts"
                    ],
                    "id": 30
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "move laterally",
                    "Object": "another system",
                    "ObjectType": "infrastructure",
                    "tactic": "Privilege Escalation",
                    "technique": [
                        "T1078-Valid Accounts"
                    ],
                    "id": 31
                }
            ],
            "T1053-Scheduled Task/Job": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "observe",
                    "Object": "command",
                    "ObjectType": "attack-pattern",
                    "tactic": "Privilege Escalation",
                    "technique": [
                        "T1053-Scheduled Task/Job"
                    ],
                    "id": 34
                }
            ]
        },
        "Credential Access": {
            "T1110-Brute Force": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "achieves",
                    "Object": "credentials access",
                    "ObjectType": "attack-pattern",
                    "tactic": "Credential Access",
                    "technique": [
                        "T1110-Brute Force"
                    ],
                    "id": 37
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "brute force",
                    "ObjectType": "attack-pattern",
                    "tactic": "Credential Access",
                    "technique": [
                        "T1110-Brute Force"
                    ],
                    "id": 38
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "credential stuffing",
                    "ObjectType": "attack-pattern",
                    "tactic": "Credential Access",
                    "technique": [
                        "T1110-Brute Force"
                    ],
                    "id": 39
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "password spraying",
                    "ObjectType": "attack-pattern",
                    "tactic": "Credential Access",
                    "technique": [
                        "T1110-Brute Force"
                    ],
                    "id": 40
                },
                {
                    "Subject": "log files",
                    "SubjectType": "artifacts",
                    "Relation": "show",
                    "Object": "login attempts",
                    "ObjectType": "attack-pattern",
                    "tactic": "Credential Access",
                    "technique": [
                        "T1110-Brute Force"
                    ],
                    "id": 41
                },
                {
                    "Subject": "login attempts",
                    "SubjectType": "attack-pattern",
                    "Relation": "originate-from",
                    "Object": "IP-addresses",
                    "ObjectType": "ipv4-addr",
                    "tactic": "Credential Access",
                    "technique": [
                        "T1110-Brute Force"
                    ],
                    "id": 42
                }
            ]
        },
        "Lateral Movement": {
            "T1210-Exploitation of Remote Services": [
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "Cobalt Strike",
                    "ObjectType": "tool",
                    "tactic": "Lateral Movement",
                    "technique": [
                        "T1210-Exploitation of Remote Services"
                    ],
                    "id": 43
                },
                {
                    "Subject": "Cobalt Strike",
                    "SubjectType": "tool",
                    "Relation": "have",
                    "Object": "built-in lateral movement possibilities",
                    "ObjectType": "Tactic",
                    "tactic": "Lateral Movement",
                    "technique": [
                        "T1210-Exploitation of Remote Services"
                    ],
                    "id": 44
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "SMB",
                    "ObjectType": "Technique",
                    "tactic": "Lateral Movement",
                    "technique": [
                        "T1210-Exploitation of Remote Services"
                    ],
                    "id": 45
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "named pipes",
                    "ObjectType": "Technique",
                    "tactic": "Lateral Movement",
                    "technique": [
                        "T1210-Exploitation of Remote Services"
                    ],
                    "id": 46
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "PsExec",
                    "ObjectType": "tool",
                    "tactic": "Lateral Movement",
                    "technique": [
                        "T1210-Exploitation of Remote Services"
                    ],
                    "id": 47
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "use",
                    "Object": "WinRM",
                    "ObjectType": "tool",
                    "tactic": "Lateral Movement",
                    "technique": [
                        "T1210-Exploitation of Remote Services"
                    ],
                    "id": 48
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "move to",
                    "Object": "domain controller",
                    "ObjectType": "infrastrcucture",
                    "tactic": "Lateral Movement",
                    "technique": [
                        "T1210-Exploitation of Remote Services"
                    ],
                    "id": 49
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "continue",
                    "Object": "lateral movement and discovery",
                    "ObjectType": "Tactic",
                    "tactic": "Lateral Movement",
                    "technique": [
                        "T1210-Exploitation of Remote Services"
                    ],
                    "id": 50
                },
                {
                    "Subject": "The adversary",
                    "SubjectType": "threat-actor",
                    "Relation": "identify",
                    "Object": "data of interest",
                    "ObjectType": "artifacts",
                    "tactic": "Lateral Movement",
                    "technique": [
                        "T1210-Exploitation of Remote Services"
                    ],
                    "id": 51
                },
                {
                    "Subject": "data of interest",
                    "SubjectType": "artifacts",
                    "Relation": "be",
                    "Object": "PII",
                    "ObjectType": "artifacts",
                    "tactic": "Lateral Movement",
                    "technique": [
                        "T1210-Exploitation of Remote Services"
                    ],
                    "id": 52
                },
                {
                    "Subject": "data of interest",
                    "SubjectType": "artifacts",
                    "Relation": "be",
                    "Object": "IP",
                    "ObjectType": "artifacts",
                    "tactic": "Lateral Movement",
                    "technique": [
                        "T1210-Exploitation of Remote Services"
                    ],
                    "id": 53
                }
            ]
        }
    }
}